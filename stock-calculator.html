<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>股票平均價格計算機｜線上試算加碼攤平後持股均價</title>
    <meta name="description" content="免費的線上股票平均價計算機，支援多筆交易。輸入每次買入的價格與股數，即可精準計算加碼或攤平後的平均持股成本。包含交易手續費與證交稅試算，是您管理持股的最佳工具。" />
    
    <!-- SEO: JSON-LD Structured Data -->
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@graph": [
        {
          "@type": "HowTo",
          "name": "如何使用股票平均成本計算機",
          "description": "透過簡單步驟，精準計算多筆股票交易的平均成本，包含手續費。",
          "step": [
            { "@type": "HowToStep", "name": "輸入交易", "text": "在輸入框中填寫您每一筆交易的「買入價格」與「買入股數」。" },
            { "@type": "HowToStep", "name": "新增更多交易", "text": "如果需要計算更多筆交易，請點擊 [＋ 新增一筆交易] 按鈕來增加欄位。" },
            { "@type": "HowToStep", "name": "設定交易成本", "text": "（選填）在下方輸入您的券商「手續費率」，讓成本計算更精準。" },
            { "@type": "HowToStep", "name": "計算結果", "text": "點擊 [計算平均成本] 按鈕，即可在下方看到您的持股分析結果，包含詳細數據與持股比例圖。" }
          ]
        },
        {
          "@type": "FAQPage",
          "mainEntity": [
            { "@type": "Question", "name": "為什麼需要計算股票的平均成本？", "acceptedAnswer": { "@type": "Answer", "text": "計算平均成本是為了明確您持股的「損益兩平點」。只有當股價高於您的平均持股成本（且高出的部分能覆蓋賣出的交易成本）時，您才是真正獲利。它幫助您制定更清晰的賣出策略。" } },
            { "@type": "Question", "name": "平均成本低於目前市價，就代表我賺錢了嗎？", "acceptedAnswer": { "@type": "Answer", "text": "不完全是。您的「帳面損益」確實是正的，但真正的獲利需要將股票賣出並「實現獲利」。賣出時會產生手續費和證交稅，所以您的賣出價格必須高於平均成本一個足以覆蓋這些費用的幅度，才是淨獲利。" } },
            { "@type": "Question", "name": "無限攤平是好的策略嗎？有什麼風險？", "acceptedAnswer": { "@type": "Answer", "text": "無限攤平是一種高風險策略。如果公司的基本面已經惡化，股價持續下跌，攤平只會讓您投入更多資金在一個沒有前景的標的上，導致虧損擴大。在決定攤平前，必須重新評估該公司的投資價值，而不是為了攤平而攤平。" } },
            { "@type": "Question", "name": "這個計算器適用於零股交易嗎？", "acceptedAnswer": { "@type": "Answer", "text": "是的，完全適用。您只需在「股數」欄位輸入您買入的零股數量即可。計算邏輯與整張股票完全相同。" } }
          ]
        }
      ]
    }
    </script>
    
    <style>
        :root {
            --primary-color: #3498db; --primary-hover-color: #2980b9; --secondary-color: #e74c3c;
            --text-color-dark: #2c3e50; --text-color-light: #333; --background-color: #f9f9f9;
            --card-background: #fff; --navbar-height: 60px; --container-width: 1200px;
            --card-shadow: 0 4px 24px rgba(52, 152, 219, 0.10); --border-radius-md: 12px; --border-radius-lg: 16px;
        }
        *, *::before, *::after { box-sizing: border-box; }
        body {
            font-family: "Microsoft JhengHei", "Noto Sans TC", Arial, sans-serif; margin: 0; padding: 0;
            background: var(--background-color); color: var(--text-color-light); line-height: 1.7; min-height: 100vh;
            overflow-x: hidden; display: flex; flex-direction: column;
        }
        main { flex: 1; }
        nav { width: 100%; background: var(--primary-color); color: #fff; position: sticky; top: 0; z-index: 1000; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .nav-container { max-width: 1200px; margin: 0 auto; display: flex; align-items: center; justify-content: space-between; padding: 0 1.5rem; height: 60px; flex-wrap: nowrap; }
        .nav-title { font-size: 1.5rem; font-weight: bold; }
        .nav-links { display: flex; gap: 2rem; font-size: 1.1rem; list-style: none; margin: 0; padding: 0; }
        nav a { color: #fff; text-decoration: none; transition: color 0.2s; }
        nav a:hover { color: #e0e0e0; }
        .hamburger-menu { display: none; width: 30px; height: 22px; flex-direction: column; justify-content: space-between; cursor: pointer; z-index: 1002; }
        .hamburger-menu .bar { display: block; width: 100%; height: 3px; background-color: #fff; border-radius: 3px; transition: all 0.3s ease-in-out; }
        .hamburger-menu.active .bar1 { transform: rotate(45deg) translate(6px, 6px); }
        .hamburger-menu.active .bar2 { opacity: 0; }
        .hamburger-menu.active .bar3 { transform: rotate(-45deg) translate(6px, -6px); }
        .menu-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); z-index: 998; opacity: 0; transition: opacity 0.3s ease; }
        .menu-overlay.show { display: block; opacity: 1; }
        h1, h2, h3, h4 { color: var(--text-color-dark); margin-top: 1.5rem; margin-bottom: 0.75rem; }
        h1 { text-align: center; font-size: 2.5rem; margin-bottom: 2rem; }
        p { margin-bottom: 1rem; }
        ul, ol { padding-left: 20px; margin-bottom: 1rem; }
        .main-layout { display: flex; gap: 2rem; max-width: 1200px; margin: 2rem auto; padding: 0 1.5rem; align-items: flex-start; }
        .main-left { flex: 2; min-width: 0; }
        .main-right { flex: 1; min-width: 220px; position: sticky; top: calc(60px + 2rem); }
        .card, .calculator-highlight { background: #fff; border-radius: 16px; box-shadow: 0 4px 24px rgba(52,152,219,0.10); padding: 2rem 1.5rem; margin-bottom: 2rem; }
        .quick-nav { background: #f4f8fb; border-radius: 12px; padding: 1.2rem 1rem; box-shadow: 0 2px 8px #eaf2f8; margin-bottom: 1.5rem; }
        .quick-nav h3 { font-size: 1.15rem; color: #217dbb; margin: 0 0 0.7rem 0; }
        .quick-nav ul { list-style: none; padding: 0; margin: 0; }
        .quick-nav li { margin-bottom: 0.7rem; }
        .quick-nav a { color: var(--primary-color); text-decoration: none; font-weight: 600; }
        .quick-nav a:hover { color: #217dbb; text-decoration: underline; }
        .tool-recommend, .news-feed { margin-bottom: 1.5rem; padding: 1.2rem; background: #fff; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        .tool-recommend h3, .news-feed h3 { font-size: 1.1rem; color: var(--text-color-dark); margin: 0 0 1rem; padding-bottom: 0.5rem; border-bottom: 1px solid #eee; }
        .tool-item, .news-item { padding: 0.8rem 0; border-bottom: 1px dashed #eaeaea; }
        .tool-item a, .news-item a { font-weight: 600; text-decoration: none; }
        .tool-item a { color: #2980b9; }
        .news-item a { color: var(--text-color-dark); }
        .tool-item:last-child, .news-item:last-child { border-bottom: none; }
        footer { background: #34495e; color: #ecf0f1; padding: 2rem 1.5rem; text-align: center; font-size: 0.95rem; line-height: 1.7; margin-top: auto; }
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; }
        .form-group label { display: block; margin-bottom: 0.5rem; font-size: 0.95rem; font-weight: 600; color: #495057; cursor: pointer; }
        .form-group small { font-size: 0.8rem; color: #6c757d; font-weight: normal; }
        .input-wrapper { position: relative; display: flex; align-items: center; }
        input { width: 100%; padding: 0.75rem; border: 1px solid #ced4da; border-radius: 8px; font-size: 1rem; transition: all 0.2s ease; }
        input:focus { border-color: var(--primary-color); outline: none; box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2); }
        .input-wrapper .input-unit { position: absolute; right: 12px; color: #888; pointer-events: none; }
        .button-group { display: flex; gap: 1rem; margin-top: 1.5rem; flex-wrap: wrap; }
        .button-group button { margin: 0; padding: 0.6rem 1.2rem; font-weight: 600; font-size: 0.95rem; border-radius: 8px; cursor: pointer; border: none; transition: all 0.2s ease; }
        .btn-submit { background: var(--primary-color); color: #fff; }
        .btn-submit:hover { background: var(--primary-hover-color); }
        .btn-secondary { background: #f1f3f5; color: #868e96; border: 1px solid #dee2e6; }
        .btn-secondary:hover { background: #e9ecef; }
        .btn-add-trade { background-color: var(--secondary-color); color: white; }
        .trade-entry { display: grid; grid-template-columns: 2fr 2fr 1fr; gap: 1rem; align-items: center; padding: 1rem; border: 1px solid #eee; border-radius: 8px; margin-bottom: 1rem; }
        .btn-remove-trade { background: #e74c3c; color: white; border: none; width: 30px; height: 30px; border-radius: 50%; cursor: pointer; font-weight: bold; }
        #result { background: linear-gradient(135deg, #f8f9fa, #e9ecef); border-left: 5px solid var(--secondary-color); padding: 1.5rem; margin-top: 2.5rem; }
        #result h3 { margin-top: 0; }
        .result-summary { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; text-align: center; margin: 1.5rem 0; }
        .result-item { background: var(--card-background); padding: 1.25rem 1rem; border-radius: var(--border-radius-md); box-shadow: 0 2px 8px rgba(0,0,0,0.06); }
        .result-item .label { display: block; font-size: 0.9rem; color: #6c757d; margin-bottom: 0.5rem; }
        .result-item .value { font-size: 1.75rem; font-weight: 700; color: var(--text-color-dark); }
        .formula-block { background-color: #f5f7f9; border-left: 4px solid var(--primary-color); padding: 1rem 1.5rem; margin: 1.5rem 0; border-radius: 0 8px 8px 0; }
        .formula-block pre { white-space: pre-wrap; word-wrap: break-word; font-size: 0.95rem; color: #333; margin: 0; }
        
        .result-chart-container { display: flex; flex-direction: column; align-items: center; gap: 1.5rem; margin-top: 2rem; padding-top: 1.5rem; border-top: 1px solid #dee2e6;}
        .pie-chart { width: 150px; height: 150px; border-radius: 50%; background-image: conic-gradient(transparent 0deg); transition: background-image 0.5s ease-in-out; }
        .chart-legend { display: flex; flex-wrap: wrap; justify-content: center; gap: 1rem; list-style: none; padding: 0; width: 100%; }
        .legend-item { display: flex; align-items: center; font-size: 0.9rem; }
        .legend-color-box { width: 16px; height: 16px; border-radius: 4px; margin-right: 8px; }

        .faq-container { border-top: 1px solid #eee; }
        .faq-item { border-bottom: 1px solid #eee; }
        .faq-item[open] summary { font-weight: 700; color: var(--primary-color); }
        .faq-item summary { outline: none; } /* Hide focus ring on summary */
        .faq-question { font-size: 1.1rem; font-weight: 600; cursor: pointer; list-style: none; display: flex; justify-content: space-between; align-items: center; transition: color 0.2s; padding: 1rem 0; }
        .faq-question::-webkit-details-marker { display: none; }
        .faq-question:hover { color: var(--primary-color); }
        .faq-icon { display: inline-block; width: 20px; height: 20px; position: relative; flex-shrink: 0; margin-left: 1rem; }
        .faq-icon::before, .faq-icon::after { content: ''; position: absolute; top: 50%; left: 50%; width: 14px; height: 2px; background-color: currentColor; transform: translate(-50%, -50%); transition: all 0.3s ease-in-out; }
        .faq-icon::after { transform: translate(-50%, -50%) rotate(90deg); }
        .faq-item[open] .faq-icon::after { transform: translate(-50%, -50%) rotate(180deg); opacity: 0; }
        .faq-answer { padding: 0.5rem 0.5rem 1.5rem; color: #555; line-height: 1.8; animation: fadeIn 0.4s ease; }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @media (max-width: 900px) {
            .hamburger-menu { display: flex; }
            .nav-links { position: fixed; left: 0; top: 0; height: 100vh; width: 250px; background-color: #2c3e50; flex-direction: column; align-items: flex-start; padding: 6rem 2rem 2rem; gap: 1.5rem; z-index: 999; transform: translateX(-100%); transition: transform 0.3s ease-in-out; }
            .nav-links.show { transform: translateX(0); }
            .nav-links a { font-size: 1.2rem; width: 100%; }
            .main-layout { flex-direction: column; padding: 0 1rem; gap: 0; }
            .main-right { position: static; width: 100%; order: 4; }
            .calculator-highlight { order: 1; }
            .main-left { order: 2; min-width: unset; width: 100%; }
            .form-grid, .result-summary { grid-template-columns: 1fr; }
            .trade-entry { grid-template-columns: 1fr 1fr; grid-template-areas: "price shares" "remove remove"; gap: 0.5rem; }
            .trade-entry .btn-remove-trade { grid-area: remove; width: 100%; border-radius: 8px; }
            .result-chart-container { flex-direction: column; }
        }
    </style>
</head>
<body>
    <nav>
        <div class="nav-container">
            <div class="nav-title">投資計算機</div>
            <div class="hamburger-menu" id="hamburger-menu">
                <span class="bar bar1"></span><span class="bar bar2"></span><span class="bar bar3"></span>
            </div>
            <div class="nav-links" id="nav-links">
               <a href="payment-method.html">定期定額複利計算機</a>
                <a href="stock-calculator.html">股票平均價計算機</a>
               <a href="https://www.ci-calculator.com/">複利計算機</a>
            </div>
        </div>
    </nav>
    <div class="menu-overlay" id="menu-overlay"></div>

    <main class="main-layout-container">
        <div class="main-layout">
            <div class="main-left">
                <section class="calculator-highlight" aria-labelledby="calculator-main-title">
                    <h1 id="calculator-main-title">股票平均價格計算機</h1>
                    <p>「<strong>強大的線上複利計算機</strong>，一站式整合<strong>複利終值 (FV)</strong> 與<strong>現值 (PV) 計算</strong>。無論是預測未來財富，還是回推達成目標所需的初始本金，都能</strong>輕鬆試算</strong>。支援</strong>年、月、日</strong>多種計息頻率，並以</strong>直觀圖表</strong>展示複利增長趨勢，助您深入了解複利財富增長奧秘。」</p>
                    <form id="stockForm">
                        <div id="trade-entries"></div>
                        <div class="button-group">
                            <button type="button" class="btn-add-trade">＋ 新增一筆交易</button>
                        </div>
                        <hr>
                        <h4>交易成本 (選填)</h4>
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="feeRate">買入手續費率</label>
                                <div class="input-wrapper">
                                    <input type="number" id="feeRate" value="0.1425" step="0.0001">
                                    <span class="input-unit">%</span>
                                </div>
                                <small>提示：輸入 0.1425 代表 0.1425%</small>
                            </div>
                            <div class="form-group">
                                <label for="taxRate">賣出證交稅率</label>
                                <div class="input-wrapper">
                                    <input type="number" id="taxRate" value="0.3" step="0.1">
                                    <span class="input-unit">%</span>
                                </div>
                            </div>
                        </div>
                        <div class="button-group">
                            <button type="submit" class="btn-submit">計算平均成本</button>
                            <button type="reset" class="btn-secondary">全部重設</button>
                        </div>
                    </form>
                    <div id="result" style="display:none;">
                        <h3>持股成本分析</h3>
                        <div class="result-summary">
                            <div class="result-item"><span class="label">平均持股成本</span><span class="value" id="avgPrice">0</span></div>
                            <div class="result-item"><span class="label">總持股數</span><span class="value" id="totalShares">0</span></div>
                            <div class="result-item"><span class="label">含成本總投入</span><span class="value" id="totalCost">0</span></div>
                        </div>
                        <div class="result-chart-container">
                            <h4>持股比例分佈</h4>
                            <div id="pieChart" class="pie-chart" role="img" aria-label="持股比例餅圖"></div>
                            <ul id="chartLegend" class="chart-legend"></ul>
                        </div>
                    </div>
                </section>
                <div class="quick-nav">
                    <ul>
                        <li><a href="#how-to-use">計算機使用說明</a></li>
                        <li><a href="#strategy">股票加碼與攤平</a></li>
                        <li><a href="#trading-costs">股票交易成本</a></li>
                        <li><a href="#stock-faq">常見問答</a></li>
                    </ul>
                </div>
                <section class="card" aria-labelledby="how-to-use">
                    <h2 id="how-to-use">計算機使用說明 & 運作原理</h2>
                    <h4>詳細步驟</h4>
                    <ol>
                        <li>在輸入框中填寫您每一筆交易的「<strong>買入價格</strong>」與「<strong>買入股數</strong>」。</li>
                        <li>如需計算多筆交易，點擊 <strong>[＋ 新增一筆交易]</strong> 即可增加欄位。</li>
                        <li>（選填）在下方輸入您的券商「<strong>手續費率</strong>」，讓成本計算更精準。</li>
                        <li>點擊 <strong>[計算平均成本]</strong> 按鈕，即可看到包含圖表的詳細持股分析。</li>
                    </ol>
                    <h4>運作原理</h4>
                    <p>本工具會加總所有交易的總成本（包含手續費），再除以總股數，得出最精確的平均持股成本。</p>
                    <div class="formula-block">
                    <pre><code>平均持股成本 = [ Σ(買入價格 × 股數) + Σ(手續費) ] / Σ(總股數)</code></pre>
                    </div>
                </section>
                <section class="card" aria-labelledby="strategy">
                    <h2 id="strategy">加碼 vs. 攤平：策略解析</h2>
                    <ul>
                        <li><strong>加碼 (Averaging Up):</strong> 當持股上漲且您持續看好時，在更高價位買入以擴大獲利部位。</li>
                        <li><strong>攤平 (Averaging Down):</strong> 當持股下跌但您認為其價值被低估時，在更低價位買入以拉低平均成本。此為高風險操作，需謹慎評估。</li>
                    </ul>
                </section>
                <section class="card" aria-labelledby="trading-costs">
                    <h2 id="trading-costs">不可忽視的交易成本</h2>
                    <ol>
                        <li><strong>手續費：</strong> 付給券商的費用，公定費率為成交金額的 0.1425%。</li>
                        <li><strong>證券交易稅：</strong> 賣出股票時繳納給政府的稅，目前台股稅率為 0.3%。</li>
                    </ol>
                </section>
                <section class="card" aria-labelledby="stock-faq">
                    <h2 id="stock-faq">股票成本計算常見問答 (FAQ)</h2>
                    <div class="faq-container">
                        <details class="faq-item">
                            <summary class="faq-question"><span>1. 為什麼需要計算股票的平均成本？</span><span class="faq-icon"></span></summary>
                            <div class="faq-answer"><p>計算平均成本是為了明確您持股的「損益兩平點」。它幫助您制定更清晰的賣出策略，避免在未覆蓋交易成本前就誤以為獲利。</p></div>
                        </details>
                        <details class="faq-item">
                            <summary class="faq-question"><span>2. 平均成本低於目前市價，就代表我賺錢了嗎？</span><span class="faq-icon"></span></summary>
                            <div class="faq-answer"><p>不完全是。這代表您有「帳面獲利」，但真正的淨獲利需要將股票賣出，並確保賣出價格高於「平均成本 + 賣出交易成本」。</p></div>
                        </details>
                        <details class="faq-item">
                            <summary class="faq-question"><span>3. 無限攤平是好的策略嗎？有什麼風險？</span><span class="faq-icon"></span></summary>
                            <div class="faq-answer"><p>無限攤平是一種高風險策略。如果公司的基本面已經惡化，攤平只會讓您投入更多資金在一個沒有前景的標的上，導致虧損擴大。</p></div>
                        </details>
                        <details class="faq-item">
                            <summary class="faq-question"><span>4. 這個計算器適用於零股交易嗎？</span><span class="faq-icon"></span></summary>
                            <div class="faq-answer"><p>是的，完全適用。您只需在「股數」欄位輸入您買入的零股數量即可，計算邏輯與整張股票完全相同。</p></div>
                        </details>
                    </div>
                </section>
            </div>
            <aside class="main-right">
                <section class="tool-recommend" aria-labelledby="other-tools-title">
                    <h3 id="other-tools-title">其他投資工具</h3>
  <div class="tool-item"><a href="future-value-calculator.html">複利終值計算機</a></div>
  <div class="tool-item"><a href="present-value-of-compound-interest.html">複利現值計算機</a></div>
  <div class="tool-item"><a href="apr-vs-apy-calculator.html">APR/APY 轉換計算機</a></div>
  <div class="tool-item"><a href="simple-interest-calculator.html">單利計算機</a></div>
  <div class="tool-item"><a href="continuous-compound-interest-calculator.html">連續複利計算機</a></div>
  <div class="tool-item"><a href="72-rule-computer.html">72法則計算機</a></div>
  <div class="tool-item"><a href="interest-rate-calculator.html">利率計算機</a></div>
  <div class="tool-item"><a href="loan-amortization-calculator.html">貸款計算機</a></div>
  <div class="tool-item"><a href="mortgage-calculator.html">抵押貸款計算機</a></div>
  <div class="tool-item"><a href="savings-bond-calculator.html">儲蓄／存款回報計算機</a></div>
  <div class="tool-item"><a href="bond-lump-sum-loan-calculator.html">債券/固定到期金額計算機</a></div>
  <div class="tool-item"><a href="roi-calculator.html">投資報酬率計算</a></div>
                </section>
                <section class="news-feed" aria-labelledby="investment-knowledge-title">
                    <h3 id="investment-knowledge-title">投資知識</h3>
  <div class="news-item"><a href="how-to-get-lower-mortgage-rate.html">複利計算機按法</a></div>
  <div class="news-item"><a href="excel-compound-interest-formula-tutorial.html">excel 複利 公式教學</a></div>
  <div class="news-item"><a href="difference-between-simple-interest-and-compound-interest.html">單利與複利差異詳解</a></div>
                </section>
            </aside>
        </div>
    </main>
    
    <footer>
        <div class="footer-content">
            <p>© 2025  股票平均成本計算機 | 本網站計算結果僅供參考，不構成投資建議</p>
        </div>
    </footer>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        const form = document.getElementById('stockForm');
        const tradeEntriesContainer = document.getElementById('trade-entries');
        const addTradeBtn = document.querySelector('.btn-add-trade');
        let tradeEntryCounter = 0;
        const CHART_COLORS = ['#3498db', '#e74c3c', '#2ecc71', '#f1c40f', '#9b59b6', '#1abc9c', '#e67e22', '#34495e'];
        const hamburger = document.getElementById('hamburger-menu');
        const navLinks = document.getElementById('nav-links');
        const overlay = document.getElementById('menu-overlay');

        const toggleMenu = () => {
            hamburger.classList.toggle('active');
            navLinks.classList.toggle('show');
            overlay.classList.toggle('show');
        };
        hamburger.addEventListener('click', (e) => { e.stopPropagation(); toggleMenu(); });
        overlay.addEventListener('click', toggleMenu);

        const addTradeEntry = (price = '', shares = '') => {
            tradeEntryCounter++;
            const entryDiv = document.createElement('div');
            entryDiv.className = 'trade-entry';
            entryDiv.innerHTML = `
                <div class="form-group">
                    <label for="trade-price-${tradeEntryCounter}">買入價格</label>
                    <input type="number" id="trade-price-${tradeEntryCounter}" class="trade-price" value="${price}" placeholder="例如: 100" step="0.01" required>
                </div>
                <div class="form-group">
                    <label for="trade-shares-${tradeEntryCounter}">買入股數</label>
                    <input type="number" id="trade-shares-${tradeEntryCounter}" class="trade-shares" value="${shares}" placeholder="例如: 1000" step="1" required>
                </div>
                <button type="button" class="btn-remove-trade" aria-label="移除此筆交易">✕</button>`;
            tradeEntriesContainer.appendChild(entryDiv);
            entryDiv.querySelector('.btn-remove-trade').addEventListener('click', () => entryDiv.remove());
        };
        addTradeBtn.addEventListener('click', () => addTradeEntry());
        addTradeEntry('100', '1000');
        addTradeEntry('90', '2000');

        if (form) {
            form.addEventListener('submit', function(e) {
                e.preventDefault();
                const entries = tradeEntriesContainer.querySelectorAll('.trade-entry');
                let totalCost = 0, totalShares = 0;
                const tradesData = [];
                const feeRate = parseFloat(document.getElementById('feeRate').value) / 100;
                if (isNaN(feeRate) || feeRate < 0) { alert('請輸入有效的手續費率。'); return; }
                entries.forEach(entry => {
                    const price = parseFloat(entry.querySelector('.trade-price').value);
                    const shares = parseFloat(entry.querySelector('.trade-shares').value);
                    if (!isNaN(price) && !isNaN(shares) && price > 0 && shares > 0) {
                        const tradeAmount = price * shares;
                        totalCost += tradeAmount * (1 + feeRate);
                        totalShares += shares;
                        tradesData.push({ price, shares });
                    }
                });
                if (totalShares > 0) {
                    const avgPrice = totalCost / totalShares;
                    document.getElementById('avgPrice').textContent = `NT$ ${avgPrice.toFixed(2)}`;
                    document.getElementById('totalShares').textContent = totalShares.toLocaleString();
                    document.getElementById('totalCost').textContent = `NT$ ${Math.round(totalCost).toLocaleString()}`;
                    generatePieChart(tradesData, totalShares);
                    const resultEl = document.getElementById('result');
                    resultEl.style.display = 'block';
                    resultEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
                } else {
                    alert('請至少輸入一筆有效的交易紀錄。');
                    document.getElementById('result').style.display = 'none';
                }
            });
            form.addEventListener('reset', function() {
                tradeEntriesContainer.innerHTML = '';
                tradeEntryCounter = 0;
                addTradeEntry('100', '1000');
                addTradeEntry('90', '2000');
                document.getElementById('result').style.display = 'none';
                document.getElementById('feeRate').value = '0.1425';
                document.getElementById('taxRate').value = '0.3';
                document.getElementById('pieChart').style.backgroundImage = 'conic-gradient(transparent 0deg)';
                document.getElementById('chartLegend').innerHTML = '';
            });
        }
        
        function generatePieChart(trades, totalShares) {
            const pieChartEl = document.getElementById('pieChart');
            const legendEl = document.getElementById('chartLegend');
            legendEl.innerHTML = '';
            let gradientString = 'conic-gradient(', currentAngle = 0;
            trades.forEach((trade, index) => {
                const percentage = (trade.shares / totalShares) * 100;
                const color = CHART_COLORS[index % CHART_COLORS.length];
                const endAngle = currentAngle + (percentage * 3.6);
                gradientString += `${color} ${currentAngle}deg ${endAngle}deg, `;
                currentAngle = endAngle;
                const legendItem = document.createElement('li');
                legendItem.className = 'legend-item';
                legendItem.innerHTML = `<span class="legend-color-box" style="background-color:${color};"></span>交易 ${index + 1} (${percentage.toFixed(1)}%)`;
                legendEl.appendChild(legendItem);
            });
            pieChartEl.style.backgroundImage = gradientString.slice(0, -2) + ')';
        }

        const faqItems = document.querySelectorAll('.faq-container .faq-item');
        faqItems.forEach(item => {
            item.addEventListener('toggle', () => {
                if (item.open) {
                    faqItems.forEach(otherItem => {
                        if (otherItem !== item) otherItem.removeAttribute('open');
                    });
                }
            });
        });

        document.querySelectorAll('a[href^="#"]').forEach(anchor => {
            anchor.addEventListener('click', function(e) {
                const targetElement = document.querySelector(this.getAttribute('href'));
                if (targetElement) {
                    e.preventDefault();
                    if (navLinks.classList.contains('show')) toggleMenu();
                    const navHeight = document.querySelector('nav').offsetHeight;
                    const offsetPosition = targetElement.getBoundingClientRect().top + window.pageYOffset - navHeight - 20;
                    window.scrollTo({ top: offsetPosition, behavior: 'smooth' });
                }
            });
        });
    });
    </script>
</body>
</html>